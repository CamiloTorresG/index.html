<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huerta Don Tarcisio | App Visual</title>
    <style>
        :root { --primary: #2d6a4f; --accent: #e07a5f; --bg: #f0f4f8; }
        body { font-family: 'Helvetica Neue', sans-serif; margin: 0; background: var(--bg); color: #1b4332; }
        
        /* Header */
        header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top:0; z-index: 100;}
        .logo { font-weight: 900; color: var(--primary); font-size: 1.3rem; letter-spacing: -1px;}
        
        /* Login */
        #login-section { text-align: center; padding: 100px 20px; min-height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center;}
        h1 { font-size: 2.5rem; margin-bottom: 10px; color: var(--primary); }
        input { padding: 15px; border: 2px solid #dde5ed; border-radius: 12px; width: 220px; font-size: 18px; text-align: center; text-transform: uppercase; font-weight: bold; letter-spacing: 2px; transition: 0.3s; outline: none;}
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.2); }
        button { padding: 15px 30px; background: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; margin-top: 20px; box-shadow: 0 4px 6px rgba(45, 106, 79, 0.2);}
        button:hover { background: #1b4332; transform: translateY(-2px); }

        /* Dashboard */
        #dashboard { display: none; max-width: 900px; margin: 30px auto; padding: 20px; }
        .welcome-banner { background: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .welcome-banner h2 { margin: 0; font-size: 2rem; color: var(--primary); }

        /* Grid de Tarjetas */
        #crops-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        
        /* NUEVA TARJETA VISUAL */
        .crop-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
        }
        .crop-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        
        /* Contenedor de la Imagen */
        .image-container {
            height: 200px;
            width: 100%;
            background: #e9ecef;
            position: relative;
            overflow: hidden;
        }
        .crop-image {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Asegura que la foto llene el espacio sin deformarse */
            transition: transform 0.5s ease;
        }
        .crop-card:hover .crop-image { transform: scale(1.05); }

        /* Overlay del Porcentaje sobre la imagen */
        .percentage-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
            padding: 20px 15px 10px;
            box-sizing: border-box;
        }
        .percentage-number { font-size: 1.8rem; font-weight: 900; }
        .percentage-label { font-size: 0.9rem; opacity: 0.9; }

        /* info del cultivo */
        .crop-info { padding: 20px; }
        .crop-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .crop-title h3 { margin: 0; font-size: 1.3rem; color: #1b4332; }
        .status-badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; background: #e8f5e9; color: var(--primary); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .crop-dates { font-size: 0.9rem; color: #6c757d; display: flex; gap: 15px; }
        .crop-dates strong { color: var(--primary); }
        
        /* Barra de tarea */
        .task-bar { background: #f8f9fa; padding: 12px 20px; font-size: 0.85rem; color: #555; border-top: 1px solid #eee; display: flex; align-items: center; }
        .task-icon { margin-right: 8px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <header>
        <div class="logo">üå± Don Tarcisio</div>
        <div id="user-display" style="font-weight:bold; color:var(--primary)">Invitado</div>
    </header>

    <div id="login-section">
        <h1>Tu Huerta en Tiempo Real</h1>
        <p>Ingresa tu c√≥digo de socio para ver el estado visual.</p>
        <input type="text" id="client-id" placeholder="C-001" value="C-001">
        <button onclick="loadDashboard()">VER MI HUERTA</button>
    </div>

    <div id="dashboard">
        <div class="welcome-banner">
            <h2>üëã Hola, Socio <span id="dash-id">...</span></h2>
            <p>Reporte visual al d√≠a de hoy (<span id="fecha-hoy"></span>):</p>
        </div>
        <div id="crops-container">
            </div>
        <div style="text-align: center; margin-top: 40px;">
             <button onclick="location.reload()" style="background:white; color:#666; border:2px solid #eee; box-shadow:none;">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <script>
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUzvNCSD2wN-L-UM4h7gQu3nb9dad_j6WYMzwn7zj3n_c4vpZucNHcHdU-ECFcLogBz2OF5ndZBS__/pub?gid=1327205092&single=true&output=csv";

        // ============================================
        // BANCO DE IM√ÅGENES (La inteligencia visual)
        // ============================================
        // Definimos 4 im√°genes para cada tipo de cultivo principal.
        // Usamos fotos gen√©ricas de alta calidad de Unsplash como ejemplo.
        
        const imageBank = {
            'tomate cherry': {
                1: 'https://images.unsplash.com/photo-1592840062661-a5a7f78e2056?w=500&q=80', // Pl√°ntula
                2: 'https://images.unsplash.com/photo-1591857177580-dc82b9ac4e10?w=500&q=80', // Planta Joven
                3: 'https://images.unsplash.com/photo-1533038590840-1cde6e668a91?w=500&q=80', // Floraci√≥n/Fruto Verde
                4: 'https://images.unsplash.com/photo-1524593166156-312f362cada0?w=500&q=80'  // Cosecha Roja
            },
            'lechuga romana': {
                1: 'https://images.unsplash.com/photo-1615485290382-441e4d049cb5?w=500&q=80', // Brote
                2: 'https://images.unsplash.com/photo-1622206151226-18ca0c960a9e?w=500&q=80', // Crecimiento
                3: 'https://images.unsplash.com/photo-1556801712-76c8eb07da76?w=500&q=80', // Casi lista
                4: 'https://images.unsplash.com/photo-1506459243355-2449c3e44317?w=500&q=80'  // Lista para comer
            },
            'espinaca': {
                1: 'https://images.unsplash.com/photo-1592840062661-a5a7f78e2056?w=500&q=80', // Pl√°ntula gen√©rica
                2: 'https://images.unsplash.com/photo-1573495627361-d9b87960b12d?w=500&q=80', // Hojas j√≥venes
                3: 'https://images.unsplash.com/photo-1576045057995-568f588f82fb?w=500&q=80', // Planta madura
                4: 'https://plus.unsplash.com/premium_photo-1664527307764-3005f55b8e36?w=500&q=80'  // Cosecha
            },
             'br√≥coli': {
                1: 'https://images.unsplash.com/photo-1592840062661-a5a7f78e2056?w=500&q=80',
                2: 'https://images.unsplash.com/photo-1603048584292-b2d74085254e?w=500&q=80',
                3: 'https://images.unsplash.com/photo-1584270354949-c26b0d5b4a0c?w=500&q=80',
                4: 'https://images.unsplash.com/photo-1459411621453-7b03977f4bfc?w=500&q=80'
            },
            // Imagen por defecto si no encontramos el cultivo
            'default': 'https://images.unsplash.com/photo-1585320806297-9794b3e4eeae?w=500&q=80'
        };


        async function loadDashboard() {
            const btn = document.querySelector('button');
            btn.innerText = "Analizando cultivos...";
            
            const clientIdInput = document.getElementById('client-id').value.toUpperCase().trim();
            const container = document.getElementById('crops-container');
            const hoy = new Date();
            document.getElementById('fecha-hoy').innerText = hoy.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            try {
                const response = await fetch(csvUrl);
                const data = await response.text();
                
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('dash-id').innerText = clientIdInput;
                document.getElementById('user-display').innerText = clientIdInput;

                let separator = data.indexOf(';') > -1 ? ';' : ',';
                const rows = data.split('\n');
                container.innerHTML = ''; 
                let found = false;

                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].split(separator);
                    if (row.length < 5) continue;

                    const dbClient = row[2] ? row[2].replace(/['"\r]/g, '').trim() : "";
                    
                    if (dbClient === clientIdInput) {
                        found = true;
                        
                        // Datos Crudos
                        const cultivoRaw = row[3] ? row[3].replace(/['"]/g, '') : "Cultivo";
                        const fechaStr = row[4] ? row[4].replace(/['"]/g, '') : "";
                        const diasTotal = parseInt(row[5] ? row[5].replace(/['"]/g, '') : "0");
                        const estado = row[6] ? row[6].replace(/['"]/g, '') : "En Proceso";
                        const tarea = row[7] ? row[7].replace(/['"\r]/g, '') : "Monitoreo y cuidados generales";

                        // C√°lculos Matem√°ticos
                        const fechaSiembra = new Date(fechaStr);
                        const diffTime = hoy - fechaSiembra;
                        const diasTranscurridos = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        let porcentaje = 0;
                        if (diasTotal > 0 && !isNaN(diasTotal)) {
                            porcentaje = (diasTranscurridos / diasTotal) * 100;
                        }
                        let visualPercent = Math.min(Math.max(porcentaje, 0), 100);

                        // =========================================
                        // L√ìGICA DE SELECCI√ìN DE IMAGEN (NUEVO)
                        // =========================================
                        let stage = 1;
                        if (visualPercent > 30) stage = 2;
                        if (visualPercent > 60) stage = 3;
                        if (visualPercent > 90) stage = 4;

                        // Normalizar nombre para buscar en el banco (minusculas, sin tildes)
                        let cultivoKey = cultivoRaw.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        
                        // Buscar la imagen, si no existe el cultivo, usar default
                        let imageUrl = imageBank['default'];
                        if (imageBank[cultivoKey] && imageBank[cultivoKey][stage]) {
                            imageUrl = imageBank[cultivoKey][stage];
                        } else {
                            // Intento de b√∫squeda parcial (ej: "Lechuga" si no encuentra "Lechuga Romana")
                            const partialKey = Object.keys(imageBank).find(key => cultivoKey.includes(key));
                            if (partialKey) {
                                imageUrl = imageBank[partialKey][stage];
                            }
                        }


                        // Renderizar Tarjeta Visual
                        const card = `
                            <div class="crop-card">
                                <div class="image-container">
                                    <img src="${imageUrl}" alt="${cultivoRaw}" class="crop-image">
                                    <div class="percentage-overlay">
                                        <div class="percentage-number">${visualPercent.toFixed(0)}%</div>
                                        <div class="percentage-label">Ciclo Completado</div>
                                    </div>
                                </div>
                                
                                <div class="crop-info">
                                    <div class="crop-title">
                                        <h3>${cultivoRaw}</h3>
                                        <span class="status-badge">${estado}</span>
                                    </div>
                                    <div class="crop-dates">
                                        <div>üå± Inicio: <strong>${new Date(fechaStr).toLocaleDateString('es-CO', {day:'2-digit', month:'short'})}</strong></div>
                                        <div>‚è±Ô∏è D√≠a: <strong>${diasTranscurridos}/${diasTotal}</strong></div>
                                    </div>
                                </div>
                                
                                <div class="task-bar">
                                    <span class="task-icon">üìù</span> Actividad hoy en huerta: ${tarea}
                                </div>
                            </div>
                        `;
                        container.innerHTML += card;
                    }
                }

                if (!found) {
                    container.innerHTML = `<p style="text-align:center; padding:30px; color:#666;">No encontramos cultivos para el socio <strong>${clientIdInput}</strong>.</p>`;
                }

            } catch (error) {
                console.error(error);
                alert("Error cargando los datos visuales.");
            }
        }
    </script>
</body>
</html>
