<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huerta Don Tarcisio | App</title>
    <style>
        :root { --primary: #2d6a4f; --accent: #e07a5f; --bg: #f7f9f8; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: #1b4332; }
        
        /* Header */
        header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .logo { font-weight: bold; color: var(--primary); font-size: 1.2rem; }
        
        /* Login Section */
        #login-section { text-align: center; padding: 50px 20px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 200px; }
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* Dashboard Section */
        #dashboard { display: none; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Barras de Progreso */
        .progress-container { background: #eee; border-radius: 10px; height: 20px; width: 100%; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #52b788, #2d6a4f); width: 0%; transition: width 1s ease-in-out; }
        
        .status-badge { float: right; font-size: 0.8rem; padding: 3px 8px; border-radius: 10px; background: #d8f3dc; color: var(--primary); }
    </style>
</head>
<body>

    <header>
        <div class="logo">ðŸŒ± Don Tarcisio</div>
        <div id="user-display">Invitado</div>
    </header>

    <div id="login-section">
        <h1>Ingresa a tu Huerta</h1>
        <p>Introduce tu ID de Cliente (ej: C-001)</p>
        <input type="text" id="client-id" placeholder="C-001" value="C-001">
        <button onclick="loadDashboard()">Ver Mi Cosecha</button>
    </div>

    <div id="dashboard">
        <h2>ðŸ‘‹ Hola, Socio <span id="dash-id"></span></h2>
        <p>Este es el estado real de tus cultivos hoy:</p>
        <div id="crops-container">Cargando datos...</div>
        <button onclick="location.reload()" style="margin-top:20px; background:#999">Salir</button>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÃ“N DE ENLACES (IMPORTANTE)
        // ==========================================
        
        // ENLACE 1: Para el inventario (Hoja "ConfiguraciÃ³n de Eras") - DÃ©jalo como estaba
        const sheetID = "2PACX-1vRUzvNCSD2wN-L-UM4h7gQu3nb9dad_j6WYMzwn7zj3n_c4vpZucNHcHdU-ECFcLogBz2OF5ndZBS__";
        
        // ENLACE 2: Para el Dashboard (Hoja "Plan de Siembra Maestro")
        // Â¡Â¡Â¡ PEGA AQUÃ EL NUEVO ENLACE QUE COPIASTE !!!
        const csvUrl_Plan = https://docs.google.com/spreadsheets/d/e/2PACX-1vRUzvNCSD2wN-L-UM4h7gQu3nb9dad_j6WYMzwn7zj3n_c4vpZucNHcHdU-ECFcLogBz2OF5ndZBS__/pub?gid=1327205092&single=true&output=csv; 

        async function loadDashboard() {
            const clientIdInput = document.getElementById('client-id').value.toUpperCase().trim();
            const container = document.getElementById('crops-container');
            
            // Cambiar pantalla
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('dash-id').innerText = clientIdInput;
            document.getElementById('user-display').innerText = clientIdInput;

            try {
                // Usamos el ENLACE 2 (Plan de Siembra)
                const response = await fetch(csvUrl_Plan);
                const data = await response.text();
                
                // Detectar separador
                let separator = data.split('\n')[0].includes(';') ? ';' : ',';
                const rows = data.split('\n').map(row => row.split(separator));

                container.innerHTML = ''; 
                let found = false;

                // Recorrer filas buscando al cliente
                // ASUMIENDO ORDEN: [0]ID_Siembra, [1]Era, [2]Cliente, [3]Cultivo, [4]Fecha, [5]Dias_Total, [6]Estado
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 5) continue; // Saltar filas vacÃ­as

                    // Limpieza de datos (quitar comillas y espacios)
                    const dbClient = row[2] ? row[2].replace(/['"]+/g, '').trim() : "";
                    
                    if (dbClient === clientIdInput) {
                        found = true;
                        const cultivo = row[3].replace(/['"]+/g, '');
                        
                        // Parsear Fecha (Formato esperado YYYY-MM-DD o similar)
                        const fechaRaw = row[4].replace(/['"]+/g, '');
                        const fechaSiembra = new Date(fechaRaw);
                        
                        // Parsear DÃ­as Totales
                        const diasTotal = parseInt(row[5].replace(/['"]+/g, ''));
                        const estado = row[6] ? row[6].replace(/['"]+/g, '') : "En proceso";
                        
                        // Si la fecha o los dÃ­as no son vÃ¡lidos, mostrar error controlado
                        if (isNaN(fechaSiembra) || isNaN(diasTotal)) {
                            console.error("Error de datos en fila:", row);
                            continue;
                        }

                        // CÃLCULO DE PROGRESO
                        const hoy = new Date();
                        // Diferencia en milisegundos
                        const diffTime = hoy - fechaSiembra; 
                        // Convertir a dÃ­as (redondear hacia arriba)
                        const diasTranscurridos = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        let porcentaje = 0;
                        if (diasTranscurridos > 0) {
                            porcentaje = (diasTranscurridos / diasTotal) * 100;
                        }
                        if (porcentaje > 100) porcentaje = 100;
                        if (porcentaje < 0) porcentaje = 0; // Por si fecha futura
                        
                        // Crear Tarjeta HTML
                        const card = `
                            <div class="card">
                                <span class="status-badge">${estado}</span>
                                <h3>ðŸŒ± ${cultivo}</h3>
                                <p><small>Sembrado: ${fechaRaw} | DÃ­a ${diasTranscurridos} de ${diasTotal}</small></p>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${porcentaje}%"></div>
                                </div>
                                <p style="text-align:right; font-size:0.8em; margin-top:5px">
                                    ${porcentaje.toFixed(0)}% Completado
                                </p>
                            </div>
                        `;
                        container.innerHTML += card;
                    }
                }

                if (!found) {
                    container.innerHTML = `<p>No encontramos cultivos activos para <strong>${clientIdInput}</strong>.<br>Verifica que en la Hoja 'Plan de Siembra Maestro' el cliente C-001 tenga cultivos asignados.</p>`;
                }

            } catch (error) {
                console.error(error);
                container.innerHTML = `<p style="color:red">Error de conexiÃ³n. Verifica que el enlace CSV sea correcto.</p>`;
            }
        }
    </script>
</body>
</html>
