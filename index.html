<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huerta Don Tarcisio | App</title>
    <style>
        :root { --primary: #2d6a4f; --accent: #e07a5f; --bg: #f7f9f8; }
        body { font-family: 'Helvetica Neue', sans-serif; margin: 0; background: var(--bg); color: #1b4332; }
        
        /* Header */
        header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .logo { font-weight: bold; color: var(--primary); font-size: 1.2rem; }
        
        /* Login Section */
        #login-section { text-align: center; padding: 80px 20px; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 5px; width: 200px; font-size: 16px; text-align: center; text-transform: uppercase;}
        button { padding: 12px 25px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s;}
        button:hover { background: #1b4332; }

        /* Dashboard Section */
        #dashboard { display: none; max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Tarjetas de Cultivo */
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card h3 { margin: 0; font-size: 1.4rem; color: var(--primary); }
        .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; background: #d8f3dc; color: var(--primary); font-weight: bold; }
        
        /* Barras de Progreso */
        .progress-container { background: #e9ecef; border-radius: 10px; height: 25px; width: 100%; margin-top: 15px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #74c69d, #2d6a4f); width: 0%; transition: width 1.5s ease-out; border-radius: 10px; }
        .progress-text { position: absolute; width: 100%; text-align: center; line-height: 25px; font-size: 12px; font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); top: 0; left: 0;}
        
        .meta-info { font-size: 0.9rem; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">üå± Don Tarcisio</div>
        <div id="user-display">Invitado</div>
    </header>

    <div id="login-section">
        <h1>Ingresa a tu Huerta</h1>
        <p>Digita tu c√≥digo de socio para ver el avance real.</p>
        <input type="text" id="client-id" placeholder="C-001" value="C-001">
        <br><br>
        <button onclick="loadDashboard()">VER MI PROGRESO</button>
    </div>

    <div id="dashboard">
        <h2>üëã Hola, Socio <span id="dash-id">...</span></h2>
        <p>As√≠ van tus cultivos al d√≠a de hoy (<span id="fecha-hoy"></span>):</p>
        <div id="crops-container">Cargando...</div>
        
        <button onclick="location.reload()" style="margin-top:30px; background:#6c757d; font-size:14px;">Cerrar Sesi√≥n</button>
    </div>

    <script>
        // Enlace DIRECTO al Plan de Siembra (CSV)
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUzvNCSD2wN-L-UM4h7gQu3nb9dad_j6WYMzwn7zj3n_c4vpZucNHcHdU-ECFcLogBz2OF5ndZBS__/pub?gid=1327205092&single=true&output=csv"; 

        async function loadDashboard() {
            const btn = document.querySelector('button');
            btn.innerText = "Conectando...";
            
            const clientIdInput = document.getElementById('client-id').value.toUpperCase().trim();
            const container = document.getElementById('crops-container');
            
            // Fecha bonita
            const hoy = new Date();
            document.getElementById('fecha-hoy').innerText = hoy.toLocaleDateString('es-CO');

            try {
                const response = await fetch(csvUrl);
                const data = await response.text();
                
                // Switch de Pantalla
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('dash-id').innerText = clientIdInput;
                document.getElementById('user-display').innerText = clientIdInput;

                // Detectar separador
                let separator = data.indexOf(';') > -1 ? ';' : ',';
                const rows = data.split('\n');

                container.innerHTML = ''; 
                let found = false;

                // Recorrer filas
                // ASUMIENDO COLUMNAS: [0]ID, [1]Era, [2]Cliente, [3]Cultivo, [4]Fecha, [5]Dias_Total, [6]Estado, [7]Tarea
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].split(separator);
                    if (row.length < 5) continue;

                    // Limpiar Cliente
                    const dbClient = row[2] ? row[2].replace(/['"\r]/g, '').trim() : "";
                    
                    if (dbClient === clientIdInput) {
                        found = true;
                        
                        // Datos
                        const cultivo = row[3] ? row[3].replace(/['"]/g, '') : "Cultivo";
                        const fechaStr = row[4] ? row[4].replace(/['"]/g, '') : "";
                        const diasTotal = parseInt(row[5] ? row[5].replace(/['"]/g, '') : "0");
                        const estado = row[6] ? row[6].replace(/['"]/g, '') : "En Proceso";
                        const tarea = row[7] ? row[7].replace(/['"\r]/g, '') : "";

                        // C√ÅLCULO MATEM√ÅTICO DEL PORCENTAJE
                        const fechaSiembra = new Date(fechaStr);
                        const diffTime = Math.abs(hoy - fechaSiembra);
                        const diasTranscurridos = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        let porcentaje = 0;
                        if (diasTotal > 0 && !isNaN(diasTotal)) {
                            porcentaje = (diasTranscurridos / diasTotal) * 100;
                        }
                        
                        // Limites visuales (0% a 100%)
                        let visualPercent = porcentaje;
                        if (visualPercent > 100) visualPercent = 100;
                        if (visualPercent < 0) visualPercent = 0;

                        // HTML de la Tarjeta
                        const card = `
                            <div class="card">
                                <div class="card-header">
                                    <h3>üå± ${cultivo}</h3>
                                    <span class="status-badge">${estado}</span>
                                </div>
                                <div class="meta-info">
                                    üìÖ Sembrado el: <strong>${fechaStr}</strong> | ‚è±Ô∏è Ciclo de ${diasTotal} d√≠as
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${visualPercent}%"></div>
                                    <div class="progress-text">${visualPercent.toFixed(1)}% Completado</div>
                                </div>
                                <div style="margin-top:10px; font-size:0.85rem; color:#444;">
                                    üìù <strong>Actividad actual en huerta:</strong> ${tarea || "Monitoreo y Riego"}
                                </div>
                            </div>
                        `;
                        container.innerHTML += card;
                    }
                }

                if (!found) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:20px;">
                            <h3>üîç No encontramos cultivos para ${clientIdInput}</h3>
                            <p>Verifica que el c√≥digo est√© bien escrito o que ya tengas siembras registradas en el sistema.</p>
                            <button onclick="location.reload()" style="background:#999">Intentar de nuevo</button>
                        </div>`;
                }

            } catch (error) {
                console.error(error);
                alert("Hubo un error cargando los datos. Revisa la consola.");
            }
        }
    </script>
</body>
</html>
