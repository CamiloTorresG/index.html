<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huerta Don Tarcisio | Diagn√≥stico</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 8px; max-width: 500px; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input { padding: 10px; width: 70%; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #2d6a4f; color: white; border: none; cursor: pointer; font-weight: bold; width: 100%; }
        #logs { margin-top: 20px; font-family: monospace; background: #eee; padding: 10px; border-radius: 5px; font-size: 12px; color: #333; }
        .card { border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 5px; background: #fff; }
    </style>
</head>
<body>

    <div class="box">
        <h2>üõ†Ô∏è Modo Diagn√≥stico</h2>
        <p>Ingresa tu ID (ej: C-001)</p>
        <input type="text" id="client-id" value="C-001">
        <button onclick="iniciarDiagnostico()">VER MI COSECHA</button>
        
        <div id="resultado" style="margin-top:20px;"></div>
        
        <h3>Registro de Actividad (Logs):</h3>
        <div id="logs">Esperando acci√≥n...</div>
    </div>

    <script>
        // TU ENLACE CSV REAL
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUzvNCSD2wN-L-UM4h7gQu3nb9dad_j6WYMzwn7zj3n_c4vpZucNHcHdU-ECFcLogBz2OF5ndZBS__/pub?gid=1327205092&single=true&output=csv";

        function log(msg) {
            const logBox = document.getElementById('logs');
            logBox.innerHTML += "<br>> " + msg;
            console.log(msg);
        }

        async function iniciarDiagnostico() {
            // 1. Verificar si el bot√≥n responde
            alert("¬°El bot√≥n funciona! Iniciando conexi√≥n...");
            log("Bot√≥n presionado. Iniciando...");
            
            const clientId = document.getElementById('client-id').value.toUpperCase().trim();
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.innerHTML = "‚è≥ Cargando...";

            try {
                log("Intentando descargar CSV desde Google...");
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error("Error de red: " + response.status);
                }

                const data = await response.text();
                log("¬°Datos descargados! Tama√±o: " + data.length + " caracteres.");
                
                // Detectar separador
                const separator = data.indexOf(';') > -1 ? ';' : ',';
                log("Separador detectado: '" + separator + "'");

                const rows = data.split('\n');
                log("Filas encontradas: " + rows.length);

                let html = "";
                let encontrado = false;

                // Buscar C-001
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].split(separator);
                    if (row.length < 3) continue;

                    // Limpieza agresiva de datos
                    const rawClient = row[2] ? row[2].replace(/['"\r]/g, '').trim() : "VACIO";
                    
                    if (rawClient === clientId) {
                        encontrado = true;
                        const cultivo = row[3] || "Desconocido";
                        const estado = row[6] || "Desconocido";
                        
                        html += `<div class='card'><strong>${cultivo}</strong><br>Estado: ${estado}</div>`;
                        log("Encontrado cultivo: " + cultivo);
                    }
                }

                if (encontrado) {
                    resultadoDiv.innerHTML = "<h3>‚úÖ Cultivos Encontrados:</h3>" + html;
                    log("Proceso terminado con √©xito.");
                } else {
                    resultadoDiv.innerHTML = "‚ùå No se encontraron datos para " + clientId;
                    log("No hubo coincidencias en el Excel.");
                    // Imprimir primeros 3 clientes para ver qu√© est√° leyendo
                    log("Muestra de clientes en Excel: " + rows[1].split(separator)[2] + ", " + rows[2].split(separator)[2]);
                }

            } catch (error) {
                alert("Error: " + error.message);
                log("ERROR CR√çTICO: " + error.message);
                resultadoDiv.innerHTML = "‚ö†Ô∏è Error t√©cnico. Mira el log abajo.";
            }
        }
    </script>
</body>
</html>
