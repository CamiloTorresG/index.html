<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huerta Don Tarcisio | App</title>
    <style>
        :root { --primary: #2d6a4f; --accent: #e07a5f; --bg: #f7f9f8; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: #1b4332; }
        
        /* Header Simple */
        header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .logo { font-weight: bold; color: var(--primary); font-size: 1.2rem; }
        
        /* Login Section */
        #login-section { text-align: center; padding: 50px 20px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 200px; }
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* Dashboard Section (Oculto al inicio) */
        #dashboard { display: none; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Barras de Progreso */
        .progress-container { background: #eee; border-radius: 10px; height: 20px; width: 100%; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #52b788, #2d6a4f); width: 0%; transition: width 1s ease-in-out; }
        
        .status-badge { float: right; font-size: 0.8rem; padding: 3px 8px; border-radius: 10px; background: #d8f3dc; color: var(--primary); }
        .fruit-icon { font-size: 1.5rem; margin-right: 10px; vertical-align: middle; }
    </style>
</head>
<body>

    <header>
        <div class="logo">ðŸŒ± Don Tarcisio</div>
        <div id="user-display">Invitado</div>
    </header>

    <div id="login-section">
        <h1>Ingresa a tu Huerta</h1>
        <p>Introduce tu ID de Cliente (ej: C-001)</p>
        <input type="text" id="client-id" placeholder="C-001" value="C-001">
        <button onclick="loadDashboard()">Ver Mi Cosecha</button>
    </div>

    <div id="dashboard">
        <h2>ðŸ‘‹ Hola, Socio <span id="dash-id"></span></h2>
        <p>Este es el estado real de tus cultivos hoy:</p>
        <div id="crops-container">
            Cargando datos de la huerta...
        </div>
    </div>

    <script>
        // TU ENLACE CSV (El mismo de antes)
        const sheetID = "2PACX-1vRUzvNCSD2wN-L-UM4h7gQu3nb9dad_j6WYMzwn7zj3n_c4vpZucNHcHdU-ECFcLogBz2OF5ndZBS__";
        const csvUrl = `https://docs.google.com/spreadsheets/d/e/${sheetID}/pub?output=csv`;

        async function loadDashboard() {
            const clientIdInput = document.getElementById('client-id').value.toUpperCase().trim();
            const container = document.getElementById('crops-container');
            
            // UI Switch
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('dash-id').innerText = clientIdInput;
            document.getElementById('user-display').innerText = clientIdInput;

            try {
                const response = await fetch(csvUrl);
                const data = await response.text();
                
                // Detectar separador (; o ,)
                let separator = data.split('\n')[0].includes(';') ? ';' : ',';
                const rows = data.split('\n').map(row => row.split(separator));

                container.innerHTML = ''; // Limpiar
                let found = false;

                // Recorrer filas (Saltando encabezados si es necesario, ajusta Ã­ndices segÃºn tu CSV)
                // ASUMIENDO ORDEN COLUMNAS: 
                // [0]ID_Siembra, [1]Era, [2]Cliente, [3]Cultivo, [4]Fecha, [5]Dias_Total, [6]Estado
                
                // Empezamos bÃºsqueda
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 5) continue;

                    const dbClient = row[2].replace(/['"]+/g, '').trim(); // Columna C (Cliente)
                    
                    if (dbClient === clientIdInput) {
                        found = true;
                        const cultivo = row[3];
                        const fechaSiembra = new Date(row[4]);
                        const diasTotal = parseInt(row[5]);
                        
                        // CÃLCULO DE PROGRESO EN VIVO
                        const hoy = new Date();
                        const diffTime = Math.abs(hoy - fechaSiembra);
                        const diasTranscurridos = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        let porcentaje = (diasTranscurridos / diasTotal) * 100;
                        if (porcentaje > 100) porcentaje = 100;
                        
                        // Renderizar Tarjeta
                        const card = `
                            <div class="card">
                                <span class="status-badge">${porcentaje >= 100 ? 'Â¡LISTO!' : 'Creciendo'}</span>
                                <h3>ðŸŒ± ${cultivo}</h3>
                                <p><small>Sembrado el: ${row[4]} | DÃ­as: ${diasTranscurridos}/${diasTotal}</small></p>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${porcentaje}%"></div>
                                </div>
                                <p style="text-align:right; font-size:0.8em; margin-top:5px">
                                    ${porcentaje.toFixed(0)}% Completado
                                </p>
                            </div>
                        `;
                        container.innerHTML += card;
                    }
                }

                if (!found) {
                    container.innerHTML = `<p>No encontramos cultivos activos para el cliente <strong>${clientIdInput}</strong>. <br>Revisa que el ID sea correcto (ej: C-001).</p>`;
                }

            } catch (error) {
                console.error(error);
                container.innerHTML = "Error conectando con la base de datos.";
            }
        }
    </script>
</body>
</html>
